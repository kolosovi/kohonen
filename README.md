# Реализация алгоритма самоорганизующихся карт Кохонена

Реализация алгоритма самоорганизующихся карт Кохонена с помощью MPI, сделанная для статьи на AlgoWiki (algowiki-project.org).

Реализация рассчитана на классификацию трехмерных векторов, представляющих цвета в пространстве RGB, поэтому векторы весов нейронов инициализируются значениями от 0 до 255. От этого ограничения можно избавиться, поменяв функцию ``kohonen_init_weights``

## Формат входных и выходных данных

Входные данные алгоритма обучение сети Кохонена --- это набор векторов. Они подаются в программу в текстовом файле. Первая строка текстового файла содержит число векторов, вторая строка содержит их размерность. Остальные строки содержат сами векторы. Каждый вектор записывается в виде разделенных запятыми чисел.

Выходные данные агоритма обучение --- это набор векторов весов. Они записываются в выходной файл в том же формате, что и входные векторы.

## Описание опций командной строки

Все опции, кроме `-p`, являются обязательными и имеют аргумент. Опция `-p` не обязательна и не имеет аргумента.

`-i PATH` - Путь к текстовому файлу с входными данными.

`-x NUMBER` - Число нейронов сетки по оси X

`-y NUMBER` - Число нейронов сетки по оси Y

`-e NUMBER` - Максимальное число итераций

`-a0 FLOAT` - Начальная скорость обучения

`-al FLOAT` - Параметр, который влияет на уменьшение скорости обучения (см. статью)

`-r0 FLOAT` - Начальный радиус обучения

`-rl FLOAT` - Параметр, который влияет на уменьшение радиуса обучения (см. статью)

`-p` - Если эта опция есть в командной строке, то главный процесс в конце выполнения напишет в стандартный поток вывода число операций с плавающей точкой. Без этой опции главный процесс пишет время выполнения в секундах.

## Компиляция на "Ломоносове"

Для компиляции нужно перейти на узел компиляции суперкомпьютера Ломоносов и загрузить OpenMPI нужной версии:

    module load openmpi/1.8.4-gcc

Нужно скопировать код в папку `~/_scratch` и выполнить команду:

    make kohonen_learn

Если все прошло успешно, в текущей директории будет лежать исполняемый файл `kohonen_learn`, предназначенный для обучения сети.

## Запуск на "Ломоносове"

На "Ломоносове" программу следует запускать с помощью команды `sbatch`, предварительно подключив Slurm:

    module load slurm/2.5.6

Так как программа линкуется с OpenMPI, то нужно использовать скрипт запуска `ompi`. Для этого нужно подключить OpenMPI командой `module load openmpi/1.8.4-gcc`. Пример команды:

    sbatch -t 15 -n 128 -o stdout_10000_neurons_129_processes.txt -p test ompi -n 128 kohonen_learn -i test_data/experiment_data.txt -x 1 -y 10000 -e 10000 -a0 0.1 -al 1000 -r0 10000 -rl 1000 -o neuron_weights_10000_neurons_128_processes.txt

Для автоматизации экспериментов был написан скрипт `submit_jobs_by_neurons.sh`. Его можно найти в корне репозитория. Параметры, используемые в скрипте, настраиваются с помощью переменных окружения. Кратко опишем параметры:

`queue` -- имя очереди Slurm, которая будет использоваться для запуска. Значение по умолчанию: `test`

`neurons_start` -- Начальное число нейронов

`neurons_max` -- Максимальное число нейронов

`neurons_step` -- Шаг, на который будет увеличиваться число нейронов

`num_procs` -- Начальное число процессов

`num_procs_step` -- Шаг, который будет использоваться при увеличении числа процессов

`num_procs_max` -- Максимальное число процессов

Стандартный поток вывода каждого экспериментального запуска перенаправляется в файл под названием `stdout_<число нейронов>_neurons_<число процессов>_processes.txt`. Веса нейронов сохраняются в файл под названием `neuron_weights_<число нейронов>_neurons_<число процессов>_processes.txt`.

Таким образом, для того, чтобы воспроизвести эксперименты, описанные в статье, нужно определить следующие переменные окружения:

    export queue=regular4
    export neurons_start=1000
    export neurons_step=1000
    export neurons_max=10000
    export num_procs=8
    export num_procs_step=8
    export num_procs_max=256

и запустить скрипт:

    cd ~/_scratch
    ./submit_jobs_by_neurons.sh
